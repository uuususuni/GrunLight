<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GrunLight â€¢ ì‹ í˜¸ ì”ì—¬ì‹œê°„ ë¯¸ë‹ˆ ì›¹</title>
  <style>
    :root{--bg:#0b0c10;--card:#15161a;--muted:#8a8f98;--acc:#4ade80;--warn:#fbbf24;--err:#f87171;--txt:#f3f4f6}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,sans-serif}
    header{padding:20px 16px;border-bottom:1px solid #222}
    h1{margin:0;font-size:18px}
    main{display:grid;grid-template-columns:1fr;gap:16px;max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid #222;border-radius:14px;padding:14px}
    .row{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,button,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2b31;background:#0e0f13;color:var(--txt)}
    button{background:#11151a;border-color:#2a2b31;cursor:pointer}
    button.primary{background:var(--acc);color:#072c11;border:none}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #23242a;text-align:left}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .green{background:rgba(74,222,128,.15);color:#86efac}
    .red{background:rgba(248,113,113,.15);color:#fecaca}
    .muted{color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

    /* LIVE PANEL */
    .live{display:flex;gap:16px;align-items:center}
    .live .big{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px 8px}
    .stateBadge{font-weight:700;font-size:14px;padding:6px 10px;border-radius:999px}
    .stateGREEN{background:rgba(74,222,128,.18);color:#bbf7d0}
    .stateRED{background:rgba(248,113,113,.18);color:#fecaca}
    .timer{font-size:64px;line-height:1.05;font-weight:800;letter-spacing:1px;margin:8px 0 0}
    .sub{font-size:12px;color:var(--muted)}
    .blink{animation:blink 1s step-start infinite}
    @keyframes blink{50%{opacity:.45}}
    .gridTwo{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kicker{font-size:12px;color:var(--muted);margin-bottom:6px}
    .rowClick tbody tr{cursor:pointer}
    .rowClick tbody tr:hover{background:#111216}
  </style>
</head>
<body>
<header>
  <h1>ğŸš¦ GrunLight â€¢ ì‹ í˜¸ ì”ì—¬ì‹œê°„ ë¯¸ë‹ˆ ì›¹</h1>
  <div class="muted">cycle/green/offset/reference_epochë§Œ ì•Œë©´ ì§€ê¸ˆ GREEN/REDì™€ ì”ì—¬ì´ˆë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. (UTC ê¸°ì¤€)</div>
</header>
<main>
  <!-- LIVE PANEL -->
  <section class="card">
    <div class="flex"><div class="muted">ë¼ì´ë¸Œ íŒ¨ë„</div><div class="right muted">UTC í˜„ì¬ì‹œê°: <span id="utcNow" class="mono"></span></div></div>
    <div class="live">
      <div class="big">
        <div id="liveName" style="font-size:16px;font-weight:600">í•­ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”</div>
        <div id="liveState" class="stateBadge stateRED" style="margin-top:8px">-</div>
        <div id="liveTimer" class="timer">00:00</div>
        <div id="liveSub" class="sub">cycle 0s â€¢ green 0s â€¢ offset 0s</div>
      </div>
    </div>
  </section>

  <!-- INPUTS -->
  <section class="card">
    <div class="row" style="align-items:end">
      <div>
        <label>ì´ë¦„</label>
        <input id="name" placeholder="ì˜ˆ) ì‹ ì‚¬ì—­ í‘¸ë¥¸ì €ì¶•ì€í–‰" />
      </div>
      <div>
        <label>cycle (ì´ˆ)</label>
        <input id="cycle" type="number" placeholder="ì˜ˆ) 190" />
      </div>
      <div>
        <label>green (ì´ˆ)</label>
        <input id="green" type="number" placeholder="ì˜ˆ) 55" />
      </div>
      <div>
        <label>offset (ì´ˆ)</label>
        <input id="offset" type="number" value="0" />
      </div>
      <div>
        <label>reference_epoch (UTC, ISO8601)</label>
        <input id="epoch" class="mono" placeholder="ì˜ˆ) 2025-09-06T11:50:50Z" />
      </div>
      <div>
        <label>ìœ„ë„(lat)</label>
        <input id="lat" type="number" step="0.000001" placeholder="ì„ íƒ" />
      </div>
      <div>
        <label>ê²½ë„(lng)</label>
        <input id="lng" type="number" step="0.000001" placeholder="ì„ íƒ" />
      </div>
    </div>
    <div class="flex" style="margin-top:10px">
      <button class="primary" id="addBtn">ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</button>
      <button id="demoBtn">ìƒ˜í”Œ(ì‹ ì‚¬ì—­ í‘¸ë¥¸ì €ì¶•ì€í–‰)</button>
      <button id="geoBtn">ê°€ê¹Œìš´ í•­ëª© ì„ íƒ(ë² íƒ€)</button>
    </div>
  </section>

  <!-- TABLE -->
  <section class="card">
    <div class="flex">
      <div class="muted">ì¶”ê°€í•œ íš¡ë‹¨ë³´ë„ (í–‰ í´ë¦­â†’ ë¼ì´ë¸Œ íŒ¨ë„ë¡œ ê³ ì •)</div>
      <div class="right">
        <button id="exportBtn">JSON ë‚´ë³´ë‚´ê¸°</button>
        <button id="clearBtn">ëª¨ë‘ ì‚­ì œ</button>
      </div>
    </div>
    <table id="tbl" class="rowClick">
      <thead>
        <tr>
          <th>ì´ë¦„</th>
          <th>ìƒíƒœ</th>
          <th>ì”ì—¬ ì´ˆ</th>
          <th>phase</th>
          <th>cycle/green/offset</th>
          <th>reference_epoch (UTC)</th>
          <th>ì¢Œí‘œ</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
const storeKey = 'gl_intersections_v2';
let items = [];
let currentIdx = 0; // ë¼ì´ë¸Œ íŒ¨ë„ì— í‘œì‹œí•  ëŒ€ìƒ

function fmtUtcNow(){ return new Date().toISOString(); }
function pad(n){return n<10?('0'+n):(''+n)}
function fmtClock(sec){ sec=Math.max(0,Math.floor(sec)); const m=Math.floor(sec/60), s=sec%60; return `${pad(m)}:${pad(s)}` }

function load(){ try{ items = JSON.parse(localStorage.getItem(storeKey)||'[]'); }catch{ items=[] } }
function save(){ localStorage.setItem(storeKey, JSON.stringify(items)); }
function addItem(obj){ items.push(obj); save(); render(); fixLiveIndex(); }
function removeAt(i){ items.splice(i,1); if(currentIdx>=items.length) currentIdx=items.length-1; save(); render(); fixLiveIndex(); }
function fixLiveIndex(){ if(items.length===0) currentIdx=0; else if(currentIdx<0) currentIdx=0; }

function compute(nowMs, it){
  const ref = Date.parse(it.reference_epoch);
  if(isNaN(ref)) return {state:'ERR', remaining:0, phase:0};
  const cycle = +it.cycle_sec, green = +it.green_sec, offset = +it.offset_sec;
  if(!(cycle>0 && green>=0 && green<=cycle)) return {state:'ERR', remaining:0, phase:0};
  const elapsed = Math.max(0, (nowMs - ref)/1000); // ë¶€ë™ì†Œìˆ˜
  const phase0 = elapsed % cycle;
  const phase = (phase0 + (offset%cycle)+cycle)%cycle;
  let state, remaining;
  if(phase < green){ state = 'GREEN'; remaining = green - phase; }
  else { state = 'RED'; remaining = cycle - phase; }
  return {state, remaining, phase};
}

function render(){
  const nowMs = Date.now();
  document.getElementById('utcNow').textContent = fmtUtcNow();

  // í…Œì´ë¸” ë Œë”
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';
  items.forEach((it, i)=>{
    const {state, remaining, phase} = compute(nowMs, it);
    const tr = document.createElement('tr');
    tr.onclick = ()=>{ currentIdx = i; renderLive(nowMs); };

    const tdName = document.createElement('td'); tdName.textContent = it.name; tr.appendChild(tdName);

    const tdState = document.createElement('td');
    tdState.innerHTML = state==='GREEN' ? '<span class="pill green">GREEN</span>' : (state==='RED' ? '<span class="pill red">RED</span>' : '<span class="pill">ERR</span>');
    tr.appendChild(tdState);

    const tdRem = document.createElement('td'); tdRem.className='mono'; tdRem.textContent = Math.floor(remaining); tr.appendChild(tdRem);

    const tdPhase = document.createElement('td'); tdPhase.className='mono'; tdPhase.textContent = Math.floor(phase); tr.appendChild(tdPhase);

    const tdCfg = document.createElement('td'); tdCfg.className='mono'; tdCfg.textContent = `${it.cycle_sec}/${it.green_sec}/${it.offset_sec}`; tr.appendChild(tdCfg);

    const tdEpoch = document.createElement('td'); tdEpoch.className='mono'; tdEpoch.textContent = it.reference_epoch; tr.appendChild(tdEpoch);

    const tdCoord = document.createElement('td'); tdCoord.className='mono'; tdCoord.textContent = (it.lat?it.lat:'') + (it.lng?','+it.lng:''); tr.appendChild(tdCoord);

    const tdBtn = document.createElement('td');
    const delBtn = document.createElement('button'); delBtn.textContent = 'ì‚­ì œ';
    delBtn.addEventListener('click', (e)=>{ e.stopPropagation(); removeAt(i); });
    tdBtn.appendChild(delBtn); tr.appendChild(tdBtn);

    tbody.appendChild(tr);
  });

  // ë¼ì´ë¸Œ íŒ¨ë„ ë Œë”
  renderLive(nowMs);
}

function renderLive(nowMs){
  const nameEl = document.getElementById('liveName');
  const stateEl = document.getElementById('liveState');
  const timerEl = document.getElementById('liveTimer');
  const subEl = document.getElementById('liveSub');

  if(items.length===0){
    nameEl.textContent = 'í•­ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”';
    stateEl.textContent = '-';
    stateEl.className = 'stateBadge';
    timerEl.textContent = '00:00';
    subEl.textContent = 'cycle 0s â€¢ green 0s â€¢ offset 0s';
    return;
  }
  const it = items[Math.max(0,Math.min(currentIdx,items.length-1))];
  const {state, remaining, phase} = compute(nowMs, it);

  nameEl.textContent = it.name + (it.lat?` â€¢ ${it.lat.toFixed(5)},${it.lng?.toFixed(5)||''}`:'');
  stateEl.textContent = state;
  stateEl.className = 'stateBadge ' + (state==='GREEN'?'stateGREEN':'stateRED');
  timerEl.textContent = fmtClock(remaining);
  timerEl.classList.toggle('blink', Math.floor(remaining)<=5);
  subEl.textContent = `cycle ${it.cycle_sec}s â€¢ green ${it.green_sec}s â€¢ offset ${it.offset_sec}s â€¢ phase ${Math.floor(phase)}s`;
}

// íƒ€ì´ë¨¸: 200ms ê°„ê²©ìœ¼ë¡œ ë¶€ë“œëŸ¬ìš´ ì¹´ìš´íŠ¸ë‹¤ìš´
setInterval(()=>render(), 200);

// UI binds
document.getElementById('addBtn').onclick = () =>{
  const obj = {
    name: document.getElementById('name').value.trim()||'ì´ë¦„ì—†ìŒ',
    cycle_sec: +document.getElementById('cycle').value,
    green_sec: +document.getElementById('green').value,
    offset_sec: +document.getElementById('offset').value||0,
    reference_epoch: document.getElementById('epoch').value.trim(),
    lat: parseFloat(document.getElementById('lat').value)||null,
    lng: parseFloat(document.getElementById('lng').value)||null,
  };
  addItem(obj);
};

document.getElementById('demoBtn').onclick = () => {
  // ìƒ˜í”Œ: ì‹ ì‚¬ì—­ í‘¸ë¥¸ì €ì¶•ì€í–‰ â€” ì…ë ¥ì¹¸ ì±„ìš°ê³ , ë°”ë¡œ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ê¹Œì§€
  const sample = {
    name: 'ì‹ ì‚¬ì—­ í‘¸ë¥¸ì €ì¶•ì€í–‰',
    cycle_sec: 190,
    green_sec: 55,
    offset_sec: 0,
    // â†“ í˜„ì¥ UTCë¡œ ë°”ê¿”ë„ OK. ì¼ë‹¨ í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ìœ ì§€
    reference_epoch: '2025-09-06T11:50:50Z',
    lat: null,
    lng: null,
  };
  // ì…ë ¥ì¹¸ì—ë„ ë³´ì´ê¸°
  document.getElementById('name').value = sample.name;
  document.getElementById('cycle').value = sample.cycle_sec;
  document.getElementById('green').value = sample.green_sec;
  document.getElementById('offset').value = sample.offset_sec;
  document.getElementById('epoch').value = sample.reference_epoch;
  // ë¦¬ìŠ¤íŠ¸ì— ì¦‰ì‹œ ì¶”ê°€
  addItem(sample);
  // ë¼ì´ë¸Œ íŒ¨ë„ ë§¨ ìœ„ í•­ëª©ìœ¼ë¡œ ê³ ì •
  currentIdx = items.length - 1;
  render();
  alert('ìƒ˜í”Œì´ ì¶”ê°€ëì–´ìš”. ë¼ì´ë¸Œ íŒ¨ë„ì—ì„œ ë°”ë¡œ í™•ì¸í•´ë³´ì„¸ìš”!');
};

document.getElementById('exportBtn').onclick = () =>{
  const blob = new Blob([JSON.stringify(items, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'intersections.json';
  a.click(); URL.revokeObjectURL(a.href);
};

document.getElementById('clearBtn').onclick = () =>{
  if(confirm('ëª¨ë“  í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?')){ items=[]; save(); render(); }
};

document.getElementById('geoBtn').onclick = () =>{
  if(!navigator.geolocation){ alert('Geolocation ë¯¸ì§€ì›'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    // ê°„ë‹¨ ìµœê·¼ì ‘ ì°¾ê¸°
    let bestIdx = -1, bestDist = Infinity;
    items.forEach((it, i)=>{
      if(!(it.lat&&it.lng)) return;
      const d = haversine(latitude, longitude, it.lat, it.lng);
      if(d < bestDist){ bestDist = d; bestIdx = i; }
    });
    if(bestIdx<0){ alert('ì¢Œí‘œê°€ ì…ë ¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
    // ë¼ì´ë¸Œ íŒ¨ë„ ëŒ€ìƒ ê³ ì •
    currentIdx = bestIdx; render();
    alert(`ê°€ê¹Œìš´ í•­ëª©: ${items[bestIdx].name} (ì•½ ${bestDist.toFixed(0)}m)`);
  }, err=> alert('ìœ„ì¹˜ ì˜¤ë¥˜: '+err.message), {enableHighAccuracy:false, timeout:8000});
};

function haversine(lat1, lon1, lat2, lon2){
  const R=6371000; const toRad=x=>x*Math.PI/180;
  const dphi=toRad(lat2-lat1), dl=toRad(lon2-lon1);
  const p1=toRad(lat1), p2=toRad(lat2);
  const a=Math.sin(dphi/2)**2 + Math.cos(p1)*Math.cos(p2)*Math.sin(dl/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

load(); render();
</script>
</body>
</html>

